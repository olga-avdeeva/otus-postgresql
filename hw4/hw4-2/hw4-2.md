- [x] Настройте сервер так, чтобы в журнал сообщений сбрасывалась информация о блокировках, удерживаемых более 200 миллисекунд. Воспроизведите ситуацию, при которой в журнале появятся такие сообщения.
  > включила запись информации об ожидании транзакций в лог: ALTER SYSTEM SET log_lock_waits = on;
  > выставиоа период ожидания для записи в лог: ALTER SYSTEM SET deadlock_timeout = 200;
  > попыталась в 3 сеансах изменить одну и ту же строку в таблице, лог приложен
- [x] Смоделируйте ситуацию обновления одной и той же строки тремя командами UPDATE в разных сеансах. Изучите возникшие блокировки в представлении pg_locks и убедитесь, что все они понятны. Пришлите список блокировок и объясните, что значит каждая.

         locktype    | database | relation | page | tuple | virtualxid | transactionid | classid | objid | objsubid | virtualtransaction |  pid  |       mode       | granted | fastpath
      ---------------+----------+----------+------+-------+------------+---------------+---------+-------+----------+--------------------+-------+------------------+---------+----------
       relation      |    16384 |    16404 |      |       |            |               |         |       |          | 5/13               | 27543 | RowExclusiveLock | t       | t
       virtualxid    |          |          |      |       | 5/13       |               |         |       |          | 5/13               | 27543 | ExclusiveLock    | t       | t
       relation      |    16384 |    16404 |      |       |            |               |         |       |          | 3/77               | 27513 | RowExclusiveLock | t       | t
       virtualxid    |          |          |      |       | 3/77       |               |         |       |          | 3/77               | 27513 | ExclusiveLock    | t       | t
       relation      |    16384 |    11645 |      |       |            |               |         |       |          | 6/262              | 27624 | AccessShareLock  | t       | t
       virtualxid    |          |          |      |       | 6/262      |               |         |       |          | 6/262              | 27624 | ExclusiveLock    | t       | t
       relation      |    16384 |    16404 |      |       |            |               |         |       |          | 4/89               | 27528 | RowExclusiveLock | t       | t
       virtualxid    |          |          |      |       | 4/89       |               |         |       |          | 4/89               | 27528 | ExclusiveLock    | t       | t
       transactionid |          |          |      |       |            |           601 |         |       |          | 4/89               | 27528 | ShareLock        | f       | f
       transactionid |          |          |      |       |            |           603 |         |       |          | 5/13               | 27543 | ExclusiveLock    | t       | f
       tuple         |    16384 |    16404 |    0 |     1 |            |               |         |       |          | 4/89               | 27528 | ExclusiveLock    | t       | f
       transactionid |          |          |      |       |            |           602 |         |       |          | 4/89               | 27528 | ExclusiveLock    | t       | f
       transactionid |          |          |      |       |            |           601 |         |       |          | 3/77               | 27513 | ExclusiveLock    | t       | f
       tuple         |    16384 |    16404 |    0 |     1 |            |               |         |       |          | 5/13               | 27543 | ExclusiveLock    | f       | f


         locktype    | relation | virtxid | xid |       mode       | granted
      ---------------+----------+---------+-----+------------------+---------
       relation      | test1    |         |     | RowExclusiveLock | t
       virtualxid    |          | 5/13    |     | ExclusiveLock    | t
       relation      | test1    |         |     | RowExclusiveLock | t
       virtualxid    |          | 3/77    |     | ExclusiveLock    | t
       relation      | pg_locks |         |     | AccessShareLock  | t
       virtualxid    |          | 6/263   |     | ExclusiveLock    | t
       relation      | test1    |         |     | RowExclusiveLock | t
       virtualxid    |          | 4/89    |     | ExclusiveLock    | t
       transactionid |          |         | 601 | ShareLock        | f
       transactionid |          |         | 603 | ExclusiveLock    | t
       tuple         | test1    |         |     | ExclusiveLock    | t
       transactionid |          |         | 602 | ExclusiveLock    | t
       transactionid |          |         | 601 | ExclusiveLock    | t
       tuple         | test1    |         |     | ExclusiveLock    | f

  > 27513 - pid 1 транзакция 1 update  
  > 27528 - pid 2 транзакция 2 update  
  > 27543 - pid 3 транзакция 3 update  
  > 27624 - pid 4 транзакция 4 select pg_locks 

1. блокировка relation (блокировка отношений) установила транзакция 3 на таблицу test1 в режиме Row Exclusive при попытке update
2. блокировка virtualxid (блокировка виртуального номера транзакции) установила транзакция 3 на свой виртуальный номер в режиме Exclusive
3. блокировка relation (блокировка отношений) установила транзакция 1 на таблицу test1 в режиме Row Exclusive при попытке update
4. блокировка virtualxid (блокировка виртуального номера транзакции) установила транзакция 1 на свой виртуальный номер в режиме Exclusive
5. блокировка relation (блокировка отношений) установила транзакция 4 на отношение pg_locks в режиме Access Share при выполнении select
6. блокировка virtualxid (блокировка виртуального номера транзакции) установила транзакция 4 на свой виртуальный номер в режиме Exclusive
7. блокировка relation (блокировка отношений) установила транзакция 2 на таблицу test1 в режиме Row Exclusive при попытке update
8. блокировка virtualxid (блокировка виртуального номера транзакции) установила транзакция 2 на свой виртуальный номер в режиме Exclusive
9. блокировка transactionid (блокировка реального номера транзакции) пытается получить транзакция 2 на номер транзакции 1, которая уже изменяет ту же строку в таблице в режиме ShareLock.
10. блокировка transactionid (блокировка реального номера транзакции) установила транзакция 3 на свой реальный номер транзакции в режиме Exclusive. Реальный номер транзакции появляется как только транзакция начинает изменять данные.
11. блокировка tuple (блокировка версии строки) установила транзакция 2 на версию строки, которую она пытается изменить в режиме Exclusive
12. блокировка transactionid (блокировка реального номера транзакции) установила транзакция 2 на свой реальный номер транзакции в режиме Exclusive. Реальный номер транзакции появляется как только транзакция начинает изменять данные.
13. блокировка transactionid (блокировка реального номера транзакции) установила транзакция 1 на свой реальный номер транзакции в режиме Exclusive. Реальный номер транзакции появляется как только транзакция начинает изменять данные.
14. блокировка tuple (блокировка версии строки) пытается получить транзакция 3 на версию строки, которую она пытается изменить в режиме Exclusive

Когда транзакция пытается изменить строку она выполняет следующую последовательность действий:
1. захватывает исключительную блокировку версии строки
2. если версия строки уже заблокирована, то запрашивает блокировку номера транзакции, которая ее заблокировала
3. если удалось получить блокировку версии строки, транзакция прописывает себя в качестве блокирующей транзакции
4. освобождает блокировку версии строки

В итоге получилось:
1 транзакция:
 - получила блокировку на свой виртуальный номер в начале транзакции
 - при попытке update получила блокировку на таблицу в режиме Row Exclusive
 - получила блокировку на свой реальный номер транзакции (который появился при попытке update) в режиме Exclusive
 - получила блокировку на версию строки, прописала себя в качестве блокирующей транзакции в эту версию строки, отпустила блокировку  
2 транзакция:
 - получила блокировку на свой виртуальный номер в начале транзакции
 - при попытке update получила блокировку на таблицу в режиме Row Exclusive
 - получила блокировку на свой реальный номер транзакции (который появился при попытке update) в режиме Exclusive
 - получила блокировку на версию строки в режиме ExclusiveLock
 - увидела что версия строки заблокирована и попыталась получить блокировку на транзакцию 1 в режиме ShareLock
3 транзакция:
 - получила блокировку на свой виртуальный номер в начале транзакции
 - при попытке update получила блокировку на таблицу в режиме Row Exclusive
 - получила блокировку на свой реальный номер транзакции (который появился при попытке update) в режиме Exclusive
 - попыталась получить блокировку на версию строки в режиме ExclusiveLock

4 транзакция:
 - получила блокировку на отношение pg_locks в режиме Access Share при выполнении select
 - получила блокировку на свой виртуальный номер



- [x] Воспроизведите взаимоблокировку трех транзакций. Можно ли разобраться в ситуации постфактум, изучая журнал сообщений?
  > по журналу сообщений можно разобраться в ситуации постфактум, в нем подробно логируется вся информация о том какие блокировки произошли, в какой последовательности и кто кого блокирует. Кроме того, при обнаружении взаимоблокировки, вся информация также подробно логируется.
- [x] Могут ли две транзакции, выполняющие единственную команду UPDATE одной и той же таблицы (без where), заблокировать друг друга?
  > получить взаимоблокировку при выполнении команды update теоретически можно, но только в том случае если одна команда будет обновлять строки таблицы в одном порядке, а другая команда в другом. Если не указывать условие в where, произойдет последовательное сканирование всей таблицы. Следовательно, не указывая никаких условий, нельзя получить взаимоблокировку, выполняя команду update. 
